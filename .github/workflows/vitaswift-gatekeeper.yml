name: Vitaswift Architecture Gatekeeper

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - master
      - develop

jobs:
  vitaswift-audit:
    name: Audit d'Architecture Vitaswift
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Execute Vitaswift Gatekeeper
        id: gatekeeper
        run: |
          echo "üöÄ Lancement de l'audit Vitaswift Architecture Gatekeeper..."
          bash vs_gatekeeper.sh .
        continue-on-error: true
      
      - name: Generate Compliance Report
        if: always()
        run: |
          echo "## üìã Rapport de Conformit√© Vitaswift" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üö® Crit√®res d'Acceptation (Z√©ro Tol√©rance)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Standard de Nommage (Prefix vs_)** - Tous les nouveaux fichiers doivent √™tre nomm√©s vs_*.lua" >> $GITHUB_STEP_SUMMARY
          echo "2. **Doctrine Zero-SQL** - Interdiction totale de fichiers .sql, auto-cr√©ation obligatoire" >> $GITHUB_STEP_SUMMARY
          echo "3. **Int√©grit√© du Bridge** - Aucune d√©pendance directe vers ESX ou QBCore" >> $GITHUB_STEP_SUMMARY
          echo "4. **Validation Sentinel** - Validation server-side stricte et check de permissions" >> $GITHUB_STEP_SUMMARY
          echo "5. **Signature d'Architecte** - Signature 'Author: Vitaswift' obligatoire" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.gatekeeper.outcome }}" == "success" ]; then
            echo "### ‚úÖ R√©sultat: APPROUV√â" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Tous les crit√®res Vitaswift sont respect√©s. Cette PR peut √™tre examin√©e." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå R√©sultat: VETO" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è **Standards Vitaswift viol√©s** - Cette Pull Request ne peut pas √™tre accept√©e en l'√©tat." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Veuillez corriger les probl√®mes identifi√©s dans les logs ci-dessus avant de soumettre √† nouveau." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Comment PR with Results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const outcome = '${{ steps.gatekeeper.outcome }}';
            const icon = outcome === 'success' ? '‚úÖ' : '‚ùå';
            const status = outcome === 'success' ? 'APPROUV√â' : 'VETO';
            const color = outcome === 'success' ? 'üü¢' : 'üî¥';
            
            let body = `## ${icon} Vitaswift Architecture Gatekeeper - ${status}\n\n`;
            body += `${color} **Statut**: ${status}\n\n`;
            body += `### üö® Crit√®res d'Acceptation (Z√©ro Tol√©rance)\n\n`;
            body += `- Standard de Nommage (Prefix vs_)\n`;
            body += `- Doctrine Zero-SQL\n`;
            body += `- Int√©grit√© du Bridge (vs_bridge)\n`;
            body += `- Validation Sentinel (S√©curit√©)\n`;
            body += `- Signature d'Architecte\n\n`;
            
            if (outcome === 'success') {
              body += `### ‚úÖ Tous les crit√®res sont respect√©s\n\n`;
              body += `Le code est conforme aux standards Vitaswift. Cette PR peut √™tre examin√©e par l'√©quipe.\n`;
            } else {
              body += `### ‚ùå Standards Vitaswift viol√©s\n\n`;
              body += `Cette Pull Request ne peut pas √™tre accept√©e en l'√©tat. Veuillez consulter les logs de l'action GitHub pour plus de d√©tails sur les probl√®mes d√©tect√©s.\n\n`;
              body += `**Action requise**: Corrigez les probl√®mes identifi√©s et poussez de nouveaux commits pour d√©clencher une nouvelle v√©rification.\n`;
            }
            
            body += `\n---\n*Audit automatique par Vitaswift Architecture Gatekeeper*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      - name: Fail if audit failed
        if: steps.gatekeeper.outcome != 'success'
        run: |
          echo "‚ùå L'audit Vitaswift a √©chou√©. Veuillez corriger les probl√®mes identifi√©s."
          exit 1
      
      - name: Success message
        if: steps.gatekeeper.outcome == 'success'
        run: |
          echo "‚úÖ L'audit Vitaswift a r√©ussi. La PR respecte tous les standards d'architecture."
